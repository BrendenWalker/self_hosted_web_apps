---
globs: .github/workflows/**/*.yml
description: CI/CD workflow patterns and conventions
---

# CI/CD Patterns

## GitHub Actions Workflow

The workflow uses a **matrix strategy** to build multiple services in parallel.

### Trigger Conditions

- **Version Tags**: Builds on semver tags on any branch. Tag format is `<service>/<version>` with **X.X.X only** (no `v` prefix), e.g. `kitchenhub/1.0.0`, `vehiclehub/2.1.3-beta.1`.
- **Pull Requests**: Builds but doesn't push (for testing)
- **Path Filters**: Only triggers when files in service directories change

### Build Process

1. **Validate semver tag** (if version tag)
2. **Set project configuration** - Determines which service to build
3. **Set image names** - Uses project-specific or default names
4. **Set build context** - Different contexts for different services
5. **Build and push images** - Uses Docker Buildx with caching
6. **Update Docker Hub descriptions** - Syncs markdown files to Docker Hub

### Image Naming

- Format: `{username}/{service}-{backend|frontend}:{tag}`
- Defaults: `kitchenhub-backend`, `kitchenhub-frontend`, `vehiclehub-backend`, `vehiclehub-frontend`
- Version tag: `X.X.X` only (e.g. `1.0.0`). Branch determines floating tag: `latest` (main) or `beta` (other branches).

### Semver Tagging Strategy

- **Tag format**: Use `<service>/<version>` with version **X.X.X only** (e.g. `kitchenhub/1.0.0`). Do not use `vX.X.X`.
- **Tag on main** (stable): Image tagged as `X.X.X` and `latest`. Pre-release on main (e.g. `1.0.0-beta.1`): `X.X.X-beta.1` only, no `latest`.
- **Tag on any other branch**: Image tagged as `X.X.X` and `beta` (floating pre-release tag).
- **Pull requests**: Tagged as `pr-{number}` (builds but doesn't push).

### Build Contexts

- **KitchenHub**: Context is `./kitchenhub/backend` or `./kitchenhub/frontend`
- **VehicleHub**: Context is `./vehiclehub` (Dockerfile uses `backend/` paths)

### Docker Hub Integration

- Automatically updates repository descriptions from `{service}/docker-descriptions/*.md`
- Uses Docker Hub API with JWT authentication
- Handles missing description files gracefully

### Secrets and Variables

**Required Secrets:**
- `DOCKER_HUB_USERNAME` - Docker Hub username
- `DOCKER_HUB_TOKEN` - Docker Hub access token

**Optional Variables:**
- `{SERVICE}_BACKEND_IMAGE_NAME` - Override backend image name
- `{SERVICE}_FRONTEND_IMAGE_NAME` - Override frontend image name
- Generic `BACKEND_IMAGE_NAME` / `FRONTEND_IMAGE_NAME` apply to all services
