---
globs: **/backend/**/*.js
description: Backend service patterns and conventions
---

# Backend Service Patterns

## Architecture

All backend services follow the same Node.js/Express pattern:

### Server Setup

```javascript
const express = require('express');
const cors = require('cors');
const { createDbPool, testConnection } = require('../../common/database/db-config');
require('dotenv').config();

const app = express();
const port = process.env.PORT || 80;

// App readiness state for health checks
let isReady = false;

// Middleware
app.use(cors());
app.use(express.json());

// Database connection
const pool = createDbPool({
  database: process.env.DB_NAME || 'defaultdb',
});
testConnection(pool); // Non-blocking test
```

### Health Check Endpoint

All services must implement `/api/health`:
- Returns **200** when app is ready (server listening)
- Returns **503** when app is not ready
- **DO NOT** query the database in health checks
- Sets `isReady = true` when server starts listening
- Include **version** in the JSON response (from `process.env.VERSION`) so the frontend can display backend version; VERSION is injected at Docker build time via build-arg

```javascript
app.get('/api/health', (req, res) => {
  const payload = {
    status: isReady ? 'ready' : 'not ready',
    timestamp: new Date().toISOString(),
    version: process.env.VERSION || 'dev'
  };
  if (isReady) {
    res.status(200).json(payload);
  } else {
    res.status(503).json(payload);
  }
});

app.listen(port, () => {
  console.log(`Server running on port ${port}`);
  isReady = true; // Mark ready after server starts
});
```

### API Endpoints

- All API routes use `/api/` prefix
- Use RESTful conventions:
  - `GET /api/resource` - List all
  - `GET /api/resource/:id` - Get single
  - `POST /api/resource` - Create
  - `PUT /api/resource/:id` - Update
  - `DELETE /api/resource/:id` - Delete
- Always use try/catch for async routes
- Return appropriate HTTP status codes (200, 201, 404, 500)
- Use parameterized queries for database operations

### Database

- Use the shared `createDbPool()` from `common/database/db-config.js`
- Always use parameterized queries to prevent SQL injection
- Handle errors gracefully with try/catch
- Use transactions for multi-step operations when needed

### Environment Variables

- `PORT` - Server port (default: 80)
- `VERSION` - Injected at Docker build time (build-arg); used in `/api/health` for version display (default: dev)
- `DB_HOST` - PostgreSQL host
- `DB_PORT` - PostgreSQL port (default: 5432)
- `DB_NAME` - Database name
- `DB_USER` - Database user
- `DB_PASSWORD` - Database password
