name: Build and Publish Docker Images

on:
  push:
    tags:
      - 'kitchenhub/v*'   # e.g., kitchenhub/v1.0.0
      - 'vehiclehub/v*'   # e.g., vehiclehub/v1.0.0
  pull_request:
    branches:
      - main
    paths:
      - 'kitchenhub/**'
      - 'vehiclehub/**'
      - '.github/workflows/docker-build.yml'

jobs:
  validate-pr:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for version checking

      - name: Validate PR has version information
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Check if PR title or body mentions version
          if echo "$PR_TITLE $PR_BODY" | grep -qiE '(version|v[0-9]+\.[0-9]+\.[0-9]+|semver|release)'; then
            echo "✓ PR contains version information"
            exit 0
          fi
          
          # Check if there are version tags in the branch
          echo "Checking for version tags in branch..."
          if git tag --merged HEAD | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+'; then
            echo "✓ Found version tags in branch history"
            exit 0
          fi
          
          echo "::warning::PR does not appear to include version information"
          echo "::notice::For releases, please include version information in the PR title or description"
          echo "::notice::Example: 'Release v1.0.0' or 'Version bump to 1.0.0'"
          # Don't fail, just warn
          exit 0

  build-and-push:
    needs: validate-pr
    if: always() && (github.event_name == 'pull_request' || (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')))
    runs-on: ubuntu-latest
    strategy:
      matrix:
        project: [kitchenhub, vehiclehub]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history required to verify tag branch ancestry

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Ensure tag commit is on main
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          # Fetch main so we can check ancestry
          git fetch origin main || true
          
          TAG_COMMIT="$(git rev-parse HEAD)"
          echo "Tag commit: ${TAG_COMMIT}"
          
          ALLOWED_BRANCHES=("origin/main")
          FOUND_ALLOWED_BRANCH=0
          
          for BRANCH in "${ALLOWED_BRANCHES[@]}"; do
            if git show-ref --verify --quiet "refs/remotes/${BRANCH}"; then
              echo "Checking if tag commit is reachable from ${BRANCH}..."
              if git merge-base --is-ancestor "${TAG_COMMIT}" "${BRANCH}"; then
                echo "✓ Tag commit is reachable from ${BRANCH}"
                FOUND_ALLOWED_BRANCH=1
                break
              else
                echo "Tag commit is NOT reachable from ${BRANCH}"
              fi
            else
              echo "Remote branch ${BRANCH} not found (skipping)"
            fi
          done
          
          if [ "${FOUND_ALLOWED_BRANCH}" -ne 1 ]; then
            echo "Error: Release tags must point to commits reachable from 'main'."
            echo "Please only create release tags on the mainline branch."
            exit 1
          fi

      - name: Determine target service from tag
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          TAG_REF="${{ github.ref_name }}"
          
          # Expect format: <service>/v<version>, e.g. kitchenhub/v1.2.3
          if [[ "$TAG_REF" != */v* ]]; then
            echo "Error: Tag '$TAG_REF' must be in the form '<service>/v<version>' (e.g., kitchenhub/v1.2.3)"
            exit 1
          fi
          
          SERVICE="${TAG_REF%%/*}"
          TAG_NAME="${TAG_REF#*/}"  # e.g., v1.2.3
          
          if [ "$SERVICE" != "kitchenhub" ] && [ "$SERVICE" != "vehiclehub" ]; then
            echo "Error: Unsupported service '$SERVICE' in tag. Expected 'kitchenhub' or 'vehiclehub'."
            exit 1
          fi
          
          VERSION="${TAG_NAME#v}"
          
          # Validate semver format (major.minor.patch with optional pre-release/build)
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?(\+[0-9A-Za-z-]+(\.[0-9A-Za-z-]+)*)?$'; then
            echo "Error: Version '$VERSION' from tag '$TAG_REF' does not follow semver format (e.g., v1.0.0, v2.1.3-beta.1)"
            exit 1
          fi
          
          echo "TARGET_SERVICE=${SERVICE}" >> $GITHUB_ENV
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_ENV
          echo "VERSION=${VERSION}" >> $GITHUB_ENV
          echo "Resolved service '$SERVICE' and version '$VERSION' from tag '$TAG_REF'"

      - name: Set project configuration
        if: github.event_name == 'pull_request' || env.TARGET_SERVICE == '' || matrix.project == env.TARGET_SERVICE
        run: |
          PROJECT_SUBFOLDER="${{ matrix.project }}"
          echo "PROJECT_SUBFOLDER=${PROJECT_SUBFOLDER}" >> $GITHUB_ENV
          
          # Set default image names based on project
          if [ "${PROJECT_SUBFOLDER}" = "kitchenhub" ]; then
            DEFAULT_BACKEND="kitchenhub-backend"
            DEFAULT_FRONTEND="kitchenhub-frontend"
          else
            DEFAULT_BACKEND="vehiclehub-backend"
            DEFAULT_FRONTEND="vehiclehub-frontend"
          fi
          echo "DEFAULT_BACKEND=${DEFAULT_BACKEND}" >> $GITHUB_ENV
          echo "DEFAULT_FRONTEND=${DEFAULT_FRONTEND}" >> $GITHUB_ENV

      - name: Set image names and tags
        if: github.event_name == 'pull_request' || env.TARGET_SERVICE == '' || matrix.project == env.TARGET_SERVICE
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          GITHUB_REF_TYPE: ${{ github.ref_type }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_EVENT_NUMBER: ${{ github.event.number }}
        run: |
          # Set image names (use project-specific variables or defaults)
          PROJECT_VAR_PREFIX=$(echo "${{ env.PROJECT_SUBFOLDER }}" | tr '[:lower:]' '[:upper:]')
          
          # Try project-specific variables first (e.g., KITCHENHUB_BACKEND_IMAGE_NAME)
          BACKEND_VAR="${PROJECT_VAR_PREFIX}_BACKEND_IMAGE_NAME"
          FRONTEND_VAR="${PROJECT_VAR_PREFIX}_FRONTEND_IMAGE_NAME"
          
          # Fall back to generic variables or defaults
          BACKEND_IMAGE_NAME="${{ vars.BACKEND_IMAGE_NAME }}"
          if [ -z "${BACKEND_IMAGE_NAME}" ]; then
            BACKEND_IMAGE_NAME="${{ env.DEFAULT_BACKEND }}"
          fi
          
          FRONTEND_IMAGE_NAME="${{ vars.FRONTEND_IMAGE_NAME }}"
          if [ -z "${FRONTEND_IMAGE_NAME}" ]; then
            FRONTEND_IMAGE_NAME="${{ env.DEFAULT_FRONTEND }}"
          fi
          
          # Docker Hub format: {username}/{repository-name}
          BACKEND_IMAGE="${DOCKER_HUB_USERNAME}/${BACKEND_IMAGE_NAME}"
          FRONTEND_IMAGE="${DOCKER_HUB_USERNAME}/${FRONTEND_IMAGE_NAME}"
          echo "BACKEND_IMAGE=${BACKEND_IMAGE}" >> $GITHUB_ENV
          echo "FRONTEND_IMAGE=${FRONTEND_IMAGE}" >> $GITHUB_ENV
          
          # Determine tags based on event type
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            # PR builds: tag with PR number (for testing, won't push)
            BACKEND_TAG="${BACKEND_IMAGE}:pr-${GITHUB_EVENT_NUMBER}"
            FRONTEND_TAG="${FRONTEND_IMAGE}:pr-${GITHUB_EVENT_NUMBER}"
            echo "Building for PR (will not push)"
          elif [ "${GITHUB_EVENT_NAME}" = "push" ] && [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            # Version tag: TAG_NAME and VERSION are set by the 'Determine target service from tag' step
            TAG_NAME="${TAG_NAME}"
            VERSION="${VERSION}"
            
            # Tag with full version tag (e.g., v1.0.0)
            BACKEND_TAG="${BACKEND_IMAGE}:${TAG_NAME}"
            FRONTEND_TAG="${FRONTEND_IMAGE}:${TAG_NAME}"
            
            # Also tag with version without 'v' prefix (e.g., 1.0.0)
            BACKEND_TAG_VERSION="${BACKEND_IMAGE}:${VERSION}"
            FRONTEND_TAG_VERSION="${FRONTEND_IMAGE}:${VERSION}"
            
            # Tag as latest only for stable releases (no pre-release identifiers)
            if [[ ! "$VERSION" =~ - ]]; then
              BACKEND_TAG_LATEST="${BACKEND_IMAGE}:latest"
              FRONTEND_TAG_LATEST="${FRONTEND_IMAGE}:latest"
              echo "Stable release detected - will also tag as 'latest'"
            else
              echo "Pre-release detected - will not tag as 'latest'"
            fi
            
            echo "Building version: ${TAG_NAME}"
          else
            echo "Error: Unexpected event type. Only version tags and pull requests are supported."
            exit 1
          fi          
          
          echo "BACKEND_TAG=${BACKEND_TAG}" >> $GITHUB_ENV
          echo "FRONTEND_TAG=${FRONTEND_TAG}" >> $GITHUB_ENV
          if [ -n "${BACKEND_TAG_VERSION:-}" ]; then echo "BACKEND_TAG_VERSION=${BACKEND_TAG_VERSION}" >> $GITHUB_ENV; fi
          if [ -n "${FRONTEND_TAG_VERSION:-}" ]; then echo "FRONTEND_TAG_VERSION=${FRONTEND_TAG_VERSION}" >> $GITHUB_ENV; fi
          if [ -n "${BACKEND_TAG_LATEST:-}" ]; then echo "BACKEND_TAG_LATEST=${BACKEND_TAG_LATEST}" >> $GITHUB_ENV; fi
          if [ -n "${FRONTEND_TAG_LATEST:-}" ]; then echo "FRONTEND_TAG_LATEST=${FRONTEND_TAG_LATEST}" >> $GITHUB_ENV; fi

      - name: Set build context
        if: github.event_name == 'pull_request' || env.TARGET_SERVICE == '' || matrix.project == env.TARGET_SERVICE
        run: |
          # Both projects now use monorepo root as context (to access common folder)
          # The Dockerfiles use paths like vehiclehub/backend/ or kitchenhub/backend/
          BACKEND_CONTEXT="."
          FRONTEND_CONTEXT="."
          echo "BACKEND_CONTEXT=${BACKEND_CONTEXT}" >> $GITHUB_ENV
          echo "FRONTEND_CONTEXT=${FRONTEND_CONTEXT}" >> $GITHUB_ENV

      - name: Build and push backend image
        if: github.event_name == 'pull_request' || env.TARGET_SERVICE == '' || matrix.project == env.TARGET_SERVICE
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.BACKEND_CONTEXT }}
          file: ./${{ env.PROJECT_SUBFOLDER }}/backend/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.BACKEND_TAG }}
            ${{ env.BACKEND_TAG_VERSION }}
            ${{ env.BACKEND_TAG_LATEST }}
          cache-from: type=registry,ref=${{ env.BACKEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.BACKEND_IMAGE }}:buildcache,mode=max

      - name: Build and push frontend image
        if: github.event_name == 'pull_request' || env.TARGET_SERVICE == '' || matrix.project == env.TARGET_SERVICE
        uses: docker/build-push-action@v5
        with:
          context: ${{ env.FRONTEND_CONTEXT }}
          file: ./${{ env.PROJECT_SUBFOLDER }}/frontend/Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: |
            ${{ env.FRONTEND_TAG }}
            ${{ env.FRONTEND_TAG_VERSION }}
            ${{ env.FRONTEND_TAG_LATEST }}
          cache-from: type=registry,ref=${{ env.FRONTEND_IMAGE }}:buildcache
          cache-to: type=registry,ref=${{ env.FRONTEND_IMAGE }}:buildcache,mode=max

      - name: Update Docker Hub repository descriptions
        if: github.event_name != 'pull_request' && (env.TARGET_SERVICE == '' || matrix.project == env.TARGET_SERVICE)
        env:
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
        run: |
          # Install jq if not available (should be pre-installed on ubuntu-latest)
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi
          
          # Function to update Docker Hub repository description
          update_dockerhub_description() {
            local repo_name=$1
            local description_file=$2
            local token=$3
            
            if [ ! -f "$description_file" ]; then
              echo "Warning: Description file not found: $description_file"
              return
            fi
            
            # Read description from markdown file and escape for JSON
            local full_description=$(cat "$description_file")
            local description_json=$(echo "$full_description" | jq -Rs .)
            
            # Update repository description
            local response=$(curl -s -w "\n%{http_code}" \
              -X PATCH \
              -H "Authorization: JWT ${token}" \
              -H "Content-Type: application/json" \
              -d "{\"full_description\": ${description_json}}" \
              "https://hub.docker.com/v2/repositories/${DOCKER_HUB_USERNAME}/${repo_name}/")
            
            local http_code=$(echo "$response" | tail -n1)
            local body=$(echo "$response" | sed '$d')
            
            if [ "$http_code" = "200" ]; then
              echo "✓ Successfully updated description for ${DOCKER_HUB_USERNAME}/${repo_name}"
            else
              echo "✗ Failed to update description for ${DOCKER_HUB_USERNAME}/${repo_name}"
              echo "  HTTP Code: $http_code"
              echo "  Response: $body"
            fi
          }
          
          # Get JWT token for Docker Hub API (reuse for both repositories)
          echo "Authenticating with Docker Hub API..."
          TOKEN=$(curl -s -H "Content-Type: application/json" \
            -X POST \
            -d "{\"username\": \"${DOCKER_HUB_USERNAME}\", \"password\": \"${DOCKER_HUB_TOKEN}\"}" \
            https://hub.docker.com/v2/users/login/ | jq -r .token)
          
          if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
            echo "Error: Failed to authenticate with Docker Hub API"
            exit 1
          fi
          
          echo "Authentication successful"
          
          # Update backend repository description
          BACKEND_REPO_NAME=$(echo "${{ env.BACKEND_IMAGE }}" | cut -d'/' -f2)
          echo "Updating description for backend repository: ${BACKEND_REPO_NAME}"
          update_dockerhub_description "$BACKEND_REPO_NAME" "./${{ env.PROJECT_SUBFOLDER }}/docker-descriptions/backend.md" "$TOKEN"
          
          # Update frontend repository description
          FRONTEND_REPO_NAME=$(echo "${{ env.FRONTEND_IMAGE }}" | cut -d'/' -f2)
          echo "Updating description for frontend repository: ${FRONTEND_REPO_NAME}"
          update_dockerhub_description "$FRONTEND_REPO_NAME" "./${{ env.PROJECT_SUBFOLDER }}/docker-descriptions/frontend.md" "$TOKEN"
